name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Lint bin/claude-yolo
        run: shellcheck -x -S warning -e SC1090 bin/claude-yolo

      - name: Lint scripts/start-chrome.sh
        run: shellcheck -x -S warning -e SC1090 scripts/start-chrome.sh

      - name: Lint strategy detect scripts
        run: shellcheck -x -S warning -e SC1090 strategies/*/detect.sh

      - name: Lint strategy entrypoints
        run: shellcheck -x -S warning -e SC1090 strategies/*/entrypoint.sh

      - name: Lint test files
        run: shellcheck -x -S warning -e SC1090 test/test-cli.sh test/test-chrome-e2e.sh test/test-chrome-multi.sh

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run test suite
        run: ./test/test-cli.sh

  docker-build-rails:
    name: Docker Build (rails)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build rails image
        uses: docker/build-push-action@v6
        with:
          context: strategies/rails/
          file: strategies/rails/Dockerfile
          tags: claude-yolo-rails:test
          load: true
          cache-from: type=gha,scope=rails
          cache-to: type=gha,mode=max,scope=rails

      - name: Verify socat is installed
        run: docker run --rm --entrypoint /bin/bash claude-yolo-rails:test -c "which socat"

      - name: Verify jq is installed
        run: docker run --rm --entrypoint /bin/bash claude-yolo-rails:test -c "which jq"

      - name: Verify npx is available
        run: docker run --rm --entrypoint /bin/bash claude-yolo-rails:test -c "which npx"

      - name: Verify claude-code is installed
        run: docker run --rm --entrypoint /bin/bash claude-yolo-rails:test -c "which claude"

      - name: Verify workspace directory exists
        run: docker run --rm --entrypoint /bin/bash claude-yolo-rails:test -c "test -d /workspace"

      - name: Verify claude user exists
        run: docker run --rm --entrypoint /bin/bash claude-yolo-rails:test -c "id claude"

      - name: Verify sudo apt-get works at runtime
        run: |
          docker run --rm --entrypoint /bin/bash claude-yolo-rails:test -c "
            sudo apt-get update -qq &&
            sudo apt-get install -y -qq tree &&
            which tree
          "

      - name: Verify MCP config can be mounted and read
        run: |
          mcp_config=$(mktemp /tmp/claude-yolo-mcp-XXXXXX)
          cat > "$mcp_config" <<'EOF'
          {
            "mcpServers": {
              "chrome-devtools": {
                "command": "npx",
                "args": ["-y", "chrome-devtools-mcp@latest", "--browser-url=http://localhost:9222"]
              }
            }
          }
          EOF
          # Mount the config and verify the container can parse it as JSON
          output=$(docker run --rm \
            --entrypoint /bin/bash \
            -v "${mcp_config}:/home/claude/.mcp.json:ro" \
            claude-yolo-rails:test \
            -c "jq -r '.mcpServers | keys[0]' /home/claude/.mcp.json")
          rm -f "$mcp_config"
          if [ "$output" = "chrome-devtools" ]; then
            echo "MCP config mount verified: server name is '$output'"
          else
            echo "ERROR: Expected 'chrome-devtools', got '$output'"
            exit 1
          fi

      - name: Verify npx can resolve chrome-devtools-mcp
        run: |
          # Verify the MCP server package exists and can be resolved (dry run)
          docker run --rm \
            --entrypoint /bin/bash \
            claude-yolo-rails:test \
            -c "npx -y chrome-devtools-mcp@latest --help 2>&1 || true" | head -5

      - name: Verify docker exec runs as claude user (not root)
        run: |
          # Start container in background (entrypoint drops to claude via gosu)
          docker run -d --name rails-exec-test \
            --entrypoint /bin/bash \
            claude-yolo-rails:test \
            -c "sleep 30"
          # docker exec defaults to root — verify --user claude works
          output=$(docker exec --user claude rails-exec-test whoami)
          docker stop rails-exec-test >/dev/null 2>&1 || true
          docker rm rails-exec-test >/dev/null 2>&1 || true
          if [ "$output" = "claude" ]; then
            echo "docker exec --user claude verified: running as '$output'"
          else
            echo "ERROR: Expected 'claude', got '$output'"
            exit 1
          fi

  docker-build-rust:
    name: Docker Build (rust)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build rust image
        uses: docker/build-push-action@v6
        with:
          context: strategies/rust/
          file: strategies/rust/Dockerfile
          tags: claude-yolo-rust:test
          load: true
          cache-from: type=gha,scope=rust
          cache-to: type=gha,mode=max,scope=rust

      - name: Verify rustc is installed
        run: docker run --rm --entrypoint /bin/bash claude-yolo-rust:test -c "rustc --version"

      - name: Verify cargo is installed
        run: docker run --rm --entrypoint /bin/bash claude-yolo-rust:test -c "cargo --version"

      - name: Verify clippy is installed
        run: docker run --rm --entrypoint /bin/bash claude-yolo-rust:test -c "clippy-driver --version"

      - name: Verify rustfmt is installed
        run: docker run --rm --entrypoint /bin/bash claude-yolo-rust:test -c "rustfmt --version"

      - name: Verify claude-code is installed
        run: docker run --rm --entrypoint /bin/bash claude-yolo-rust:test -c "which claude"

      - name: Verify workspace directory exists
        run: docker run --rm --entrypoint /bin/bash claude-yolo-rust:test -c "test -d /workspace"

      - name: Verify claude user exists
        run: docker run --rm --entrypoint /bin/bash claude-yolo-rust:test -c "id claude"

      - name: Verify sudo apt-get works at runtime
        run: |
          docker run --rm --entrypoint /bin/bash claude-yolo-rust:test -c "
            sudo apt-get update -qq &&
            sudo apt-get install -y -qq tree &&
            which tree
          "

      - name: Smoke-test cargo inside container
        run: |
          docker run --rm \
            --entrypoint /bin/bash \
            claude-yolo-rust:test \
            -c "cargo init --name smoke-test /tmp/smoke && cd /tmp/smoke && cargo test 2>&1"

      - name: Verify docker exec runs as claude user (not root)
        run: |
          # Start container in background (entrypoint drops to claude via gosu)
          docker run -d --name rust-exec-test \
            --entrypoint /bin/bash \
            claude-yolo-rust:test \
            -c "sleep 30"
          # docker exec defaults to root — verify --user claude works
          output=$(docker exec --user claude rust-exec-test whoami)
          docker stop rust-exec-test >/dev/null 2>&1 || true
          docker rm rust-exec-test >/dev/null 2>&1 || true
          if [ "$output" = "claude" ]; then
            echo "docker exec --user claude verified: running as '$output'"
          else
            echo "ERROR: Expected 'claude', got '$output'"
            exit 1
          fi

  docker-build-python:
    name: Docker Build (python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build python image
        uses: docker/build-push-action@v6
        with:
          context: strategies/python/
          file: strategies/python/Dockerfile
          tags: claude-yolo-python:test
          load: true
          cache-from: type=gha,scope=python
          cache-to: type=gha,mode=max,scope=python

      - name: Verify pyenv is installed
        run: docker run --rm --user claude --entrypoint /bin/bash claude-yolo-python:test -c "pyenv --version"

      - name: Verify claude-code is installed
        run: docker run --rm --entrypoint /bin/bash claude-yolo-python:test -c "which claude"

      - name: Verify workspace directory exists
        run: docker run --rm --entrypoint /bin/bash claude-yolo-python:test -c "test -d /workspace"

      - name: Verify claude user exists
        run: docker run --rm --entrypoint /bin/bash claude-yolo-python:test -c "id claude"

      - name: Verify sudo apt-get works at runtime
        run: |
          docker run --rm --entrypoint /bin/bash claude-yolo-python:test -c "
            sudo apt-get update -qq &&
            sudo apt-get install -y -qq tree &&
            which tree
          "

      - name: Smoke-test pyenv install and pip inside container
        run: |
          docker run --rm \
            --user claude \
            --entrypoint /bin/bash \
            claude-yolo-python:test \
            -c '
              export PYENV_ROOT="$HOME/.pyenv"
              export PATH="$PYENV_ROOT/bin:$PYENV_ROOT/shims:$PATH"
              eval "$(pyenv init -)"
              pyenv install 3.12 &&
              pyenv global 3.12 &&
              python --version &&
              pip --version
            '

      - name: Verify docker exec runs as claude user (not root)
        run: |
          docker run -d --name python-exec-test \
            --entrypoint /bin/bash \
            claude-yolo-python:test \
            -c "sleep 30"
          output=$(docker exec --user claude python-exec-test whoami)
          docker stop python-exec-test >/dev/null 2>&1 || true
          docker rm python-exec-test >/dev/null 2>&1 || true
          if [ "$output" = "claude" ]; then
            echo "docker exec --user claude verified: running as '$output'"
          else
            echo "ERROR: Expected 'claude', got '$output'"
            exit 1
          fi

  docker-build-node:
    name: Docker Build (node)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build node image
        uses: docker/build-push-action@v6
        with:
          context: strategies/node/
          file: strategies/node/Dockerfile
          tags: claude-yolo-node:test
          load: true
          cache-from: type=gha,scope=node
          cache-to: type=gha,mode=max,scope=node

      - name: Verify nvm is installed
        run: |
          docker run --rm --user claude --entrypoint /bin/bash claude-yolo-node:test -c '
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            nvm --version
          '

      - name: Verify claude-code is installed
        run: docker run --rm --entrypoint /bin/bash claude-yolo-node:test -c "which claude"

      - name: Verify workspace directory exists
        run: docker run --rm --entrypoint /bin/bash claude-yolo-node:test -c "test -d /workspace"

      - name: Verify claude user exists
        run: docker run --rm --entrypoint /bin/bash claude-yolo-node:test -c "id claude"

      - name: Verify sudo apt-get works at runtime
        run: |
          docker run --rm --entrypoint /bin/bash claude-yolo-node:test -c "
            sudo apt-get update -qq &&
            sudo apt-get install -y -qq tree &&
            which tree
          "

      - name: Smoke-test nvm install and npm inside container
        run: |
          docker run --rm \
            --user claude \
            --entrypoint /bin/bash \
            claude-yolo-node:test \
            -c '
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
              nvm install 20 &&
              node --version &&
              npm --version &&
              cd /tmp && npm init -y &&
              npm install lodash &&
              node -e "console.log(require(\"lodash\").VERSION)"
            '

      - name: Verify docker exec runs as claude user (not root)
        run: |
          docker run -d --name node-exec-test \
            --entrypoint /bin/bash \
            claude-yolo-node:test \
            -c "sleep 30"
          output=$(docker exec --user claude node-exec-test whoami)
          docker stop node-exec-test >/dev/null 2>&1 || true
          docker rm node-exec-test >/dev/null 2>&1 || true
          if [ "$output" = "claude" ]; then
            echo "docker exec --user claude verified: running as '$output'"
          else
            echo "ERROR: Expected 'claude', got '$output'"
            exit 1
          fi

  docker-build-go:
    name: Docker Build (go)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build go image
        uses: docker/build-push-action@v6
        with:
          context: strategies/go/
          file: strategies/go/Dockerfile
          tags: claude-yolo-go:test
          load: true
          cache-from: type=gha,scope=go
          cache-to: type=gha,mode=max,scope=go

      - name: Verify go is installed
        run: docker run --rm --entrypoint /bin/bash claude-yolo-go:test -c "go version"

      - name: Verify claude-code is installed
        run: docker run --rm --entrypoint /bin/bash claude-yolo-go:test -c "which claude"

      - name: Verify workspace directory exists
        run: docker run --rm --entrypoint /bin/bash claude-yolo-go:test -c "test -d /workspace"

      - name: Verify claude user exists
        run: docker run --rm --entrypoint /bin/bash claude-yolo-go:test -c "id claude"

      - name: Verify sudo apt-get works at runtime
        run: |
          docker run --rm --entrypoint /bin/bash claude-yolo-go:test -c "
            sudo apt-get update -qq &&
            sudo apt-get install -y -qq tree &&
            which tree
          "

      - name: Smoke-test go build inside container
        run: |
          docker run --rm \
            --user claude \
            --entrypoint /bin/bash \
            claude-yolo-go:test \
            -c '
              export GOPATH="$HOME/go"
              export PATH="$GOPATH/bin:/usr/local/go/bin:$PATH"
              mkdir -p /tmp/smoke && cd /tmp/smoke &&
              go mod init smoke-test &&
              cat > main.go <<GOEOF
          package main

          import "fmt"

          func main() { fmt.Println("hello from go") }
          GOEOF
              go build -o smoke . &&
              ./smoke &&
              go test ./... 2>&1 || true
            '

      - name: Verify docker exec runs as claude user (not root)
        run: |
          docker run -d --name go-exec-test \
            --entrypoint /bin/bash \
            claude-yolo-go:test \
            -c "sleep 30"
          output=$(docker exec --user claude go-exec-test whoami)
          docker stop go-exec-test >/dev/null 2>&1 || true
          docker rm go-exec-test >/dev/null 2>&1 || true
          if [ "$output" = "claude" ]; then
            echo "docker exec --user claude verified: running as '$output'"
          else
            echo "ERROR: Expected 'claude', got '$output'"
            exit 1
          fi

  chrome-e2e:
    name: Chrome CDP E2E
    runs-on: ubuntu-latest
    needs: docker-build-rails
    steps:
      - uses: actions/checkout@v4

      - name: Run Chrome CDP end-to-end tests
        run: ./test/test-chrome-e2e.sh

  chrome-multi-e2e:
    name: Chrome Multi-Instance Isolation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Chrome multi-instance isolation tests
        run: ./test/test-chrome-multi.sh
